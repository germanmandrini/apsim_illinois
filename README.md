# Simulations for fields in Illinois using APSIM
Codes to run multiple APSIM simulations on Illinois-US

# Objective
This codes allow to obtain a database simulated with APSIM for 4200 fields over 30 years.
The codes start by obtianing the field information , the soils parameters and the weather files
Then it run simulations with increasing Nitrogen rates
Finally it merges the output and evaluates different N recommendation tools.

# Contact
Questions about the code and methodology: German Mandrini, Dpt of Crop Sciences, University of Illinois at Urbana-Champaign, germanmandrini@gmail.com

Questions about collaborations: Nicolas F Martin, Dpt of Crop Sciences, University of Illinois at Urbana-Champaign, nfmartin@illinois.edu

# About the code
The scripts used to obtain soil data and transform it into APSIM files are adapted from https://github.com/rmartinezferia/APssurgo

# Description
<!--table
	{mso-displayed-decimal-separator:"\.";
	mso-displayed-thousand-separator:"\,";}
.xl1524526
	{padding-top:1px;
	padding-right:1px;
	padding-left:1px;
	mso-ignore:padding;
	color:black;
	font-size:11.0pt;
	font-weight:400;
	font-style:normal;
	text-decoration:none;
	font-family:Calibri, sans-serif;
	mso-font-charset:0;
	mso-number-format:General;
	text-align:general;
	vertical-align:bottom;
	mso-background-source:auto;
	mso-pattern:auto;
	white-space:nowrap;}
.xl6524526
	{padding-top:1px;
	padding-right:1px;
	padding-left:1px;
	mso-ignore:padding;
	color:black;
	font-size:11.0pt;
	font-weight:700;
	font-style:normal;
	text-decoration:none;
	font-family:Calibri, sans-serif;
	mso-font-charset:0;
	mso-number-format:General;
	text-align:general;
	vertical-align:bottom;
	border:.5pt solid windowtext;
	mso-background-source:auto;
	mso-pattern:auto;
	white-space:nowrap;}
.xl6624526
	{padding-top:1px;
	padding-right:1px;
	padding-left:1px;
	mso-ignore:padding;
	color:black;
	font-size:11.0pt;
	font-weight:400;
	font-style:normal;
	text-decoration:none;
	font-family:Calibri, sans-serif;
	mso-font-charset:0;
	mso-number-format:General;
	text-align:general;
	vertical-align:bottom;
	border:.5pt solid windowtext;
	mso-background-source:auto;
	mso-pattern:auto;
	white-space:normal;}
.xl6724526
	{padding-top:1px;
	padding-right:1px;
	padding-left:1px;
	mso-ignore:padding;
	color:black;
	font-size:11.0pt;
	font-weight:400;
	font-style:normal;
	text-decoration:none;
	font-family:Calibri, sans-serif;
	mso-font-charset:0;
	mso-number-format:General;
	text-align:general;
	vertical-align:bottom;
	border:.5pt solid windowtext;
	mso-background-source:auto;
	mso-pattern:auto;
	white-space:nowrap;}
.xl6824526
	{padding-top:1px;
	padding-right:1px;
	padding-left:1px;
	mso-ignore:padding;
	color:#0563C1;
	font-size:11.0pt;
	font-weight:400;
	font-style:normal;
	text-decoration:underline;
	text-underline-style:single;
	font-family:Calibri, sans-serif;
	mso-font-charset:0;
	mso-number-format:General;
	text-align:left;
	vertical-align:bottom;
	border:.5pt solid windowtext;
	mso-background-source:auto;
	mso-pattern:auto;
	white-space:nowrap;}
.xl6924526
	{padding-top:1px;
	padding-right:1px;
	padding-left:1px;
	mso-ignore:padding;
	color:black;
	font-size:11.0pt;
	font-weight:400;
	font-style:normal;
	text-decoration:none;
	font-family:Calibri, sans-serif;
	mso-font-charset:0;
	mso-number-format:General;
	text-align:left;
	vertical-align:bottom;
	border:.5pt solid windowtext;
	mso-background-source:auto;
	mso-pattern:auto;
	white-space:nowrap;}
-->
</style>
</head>

<body>
<!--[if !excel]>&nbsp;&nbsp;<![endif]-->
<!--The following information was generated by Microsoft Excel's Publish as Web
Page wizard.-->
<!--If the same item is republished from Excel, all information between the DIV
tags will be replaced.-->
<!----------------------------->
<!--START OF OUTPUT FROM EXCEL PUBLISH AS WEB PAGE WIZARD -->
<!----------------------------->

<div id="codes_index2021_24526" align=center x:publishsource="Excel">

<table border=0 cellpadding=0 cellspacing=0 width=1047 style='border-collapse:
 collapse;table-layout:fixed;width:786pt'>
 <col width=64 style='width:48pt'>
 <col width=394 style='mso-width-source:userset;mso-width-alt:14409;width:296pt'>
 <col width=589 style='mso-width-source:userset;mso-width-alt:21540;width:442pt'>
 <tr height=20 style='height:15.0pt'>
  <td height=20 class=xl1524526 colspan=2 width=458 style='height:15.0pt;
  width:344pt'>FOLDER WITH ALL DATA FILES</td>
  <td class=xl1524526 width=589 style='width:442pt'></td>
 </tr>
 <tr height=20 style='height:15.0pt'>
  <td colspan=2 height=20 class=xl6824526 style='height:15.0pt'><a
  href="https://uofi.box.com/s/d6a9rcwv1znpy9ipmsj6r33vet2qxvq5">https://uofi.box.com/s/d6a9rcwv1znpy9ipmsj6r33vet2qxvq5</a></td>
  <td class=xl6724526 style='border-left:none'>Download it and link it to the
  codes files when needed</td>
 </tr>
 <tr height=20 style='height:15.0pt'>
  <td height=20 class=xl1524526 style='height:15.0pt'></td>
  <td class=xl1524526></td>
  <td class=xl1524526></td>
 </tr>
 <tr height=20 style='height:15.0pt'>
  <td height=20 class=xl1524526 colspan=2 style='height:15.0pt'>INITIAL SET UP
  OF FILES FOR RUNNING THE SIMULATIONS</td>
  <td class=xl1524526></td>
 </tr>
 <tr height=20 style='height:15.0pt'>
  <td height=20 class=xl6524526 style='height:15.0pt'>Order</td>
  <td class=xl6524526 style='border-left:none'>File name</td>
  <td class=xl6524526 style='border-left:none'>Objective</td>
 </tr>
 <tr height=20 style='height:15.0pt'>
  <td height=20 class=xl6724526 align=right style='height:15.0pt;border-top:
  none'>1</td>
  <td class=xl6724526 style='border-top:none;border-left:none'>grid_10_creation.R</td>
  <td class=xl6624526 width=589 style='border-top:none;border-left:none;
  width:442pt'>Code to create a grid of 10x10 km over Illinois</td>
 </tr>
 <tr height=20 style='height:15.0pt'>
  <td height=20 class=xl6724526 align=right style='height:15.0pt;border-top:
  none'>2</td>
  <td class=xl6724526 style='border-top:none;border-left:none'>grid_10_update.R</td>
  <td class=xl6624526 width=589 style='border-top:none;border-left:none;
  width:442pt'>Update the grid with the area of corn</td>
 </tr>
 <tr height=20 style='height:15.0pt'>
  <td height=20 class=xl6724526 align=right style='height:15.0pt;border-top:
  none'>3</td>
  <td class=xl6724526 style='border-top:none;border-left:none'>z_downloader.R</td>
  <td class=xl6624526 width=589 style='border-top:none;border-left:none;
  width:442pt'>Code to download the weather of the centroid of each cell</td>
 </tr>
 <tr height=20 style='height:15.0pt'>
  <td height=20 class=xl6724526 align=right style='height:15.0pt;border-top:
  none'>4</td>
  <td class=xl6724526 style='border-top:none;border-left:none'>z_creator_nov20.R</td>
  <td class=xl6624526 width=589 style='border-top:none;border-left:none;
  width:442pt'>Randomize the weather</td>
 </tr>
 <tr height=20 style='height:15.0pt'>
  <td height=20 class=xl6724526 align=right style='height:15.0pt;border-top:
  none'>5</td>
  <td class=xl6724526 style='border-top:none;border-left:none'>fields_selector_manager.R</td>
  <td class=xl6624526 width=589 style='border-top:none;border-left:none;
  width:442pt'>Code to spit the the grid file in tiles and call the fields
  selector in parallel</td>
 </tr>
 <tr height=20 style='height:15.0pt'>
  <td height=20 class=xl6724526 align=right style='height:15.0pt;border-top:
  none'>6</td>
  <td class=xl6724526 style='border-top:none;border-left:none'>fields_selector_parallel_focal_v2.R</td>
  <td class=xl6624526 width=589 style='border-top:none;border-left:none;
  width:442pt'>Code to select fields on each cell in parallel</td>
 </tr>
 <tr height=20 style='height:15.0pt'>
  <td height=20 class=xl6724526 align=right style='height:15.0pt;border-top:
  none'>7</td>
  <td class=xl6724526 style='border-top:none;border-left:none'>clean_fields_step1.R</td>
  <td class=xl6624526 width=589 style='border-top:none;border-left:none;
  width:442pt'>Clean fields. Leave only three soils</td>
 </tr>
 <tr height=20 style='height:15.0pt'>
  <td height=20 class=xl6724526 align=right style='height:15.0pt;border-top:
  none'>8</td>
  <td class=xl6724526 style='border-top:none;border-left:none'>soils_manager_Nov29.R</td>
  <td class=xl6624526 width=589 style='border-top:none;border-left:none;
  width:442pt'>Download horizons for each soil</td>
 </tr>
 <tr height=20 style='height:15.0pt'>
  <td height=20 class=xl6724526 align=right style='height:15.0pt;border-top:
  none'>9</td>
  <td class=xl6724526 style='border-top:none;border-left:none'>clean_fields_step2.R</td>
  <td class=xl6624526 width=589 style='border-top:none;border-left:none;
  width:442pt'>Clean fields again, remove soils polygon whose horizons were not
  found</td>
 </tr>
 <tr height=20 style='height:15.0pt'>
  <td height=20 class=xl6724526 align=right style='height:15.0pt;border-top:
  none'>10</td>
  <td class=xl6724526 style='border-top:none;border-left:none'>planting_dates_soil_temp_jul24.R</td>
  <td class=xl6724526 style='border-top:none;border-left:none'>Select planting
  dates for each cell<span style='mso-spacerun:yes'>Â </span></td>
 </tr>
 <tr height=20 style='height:15.0pt'>
  <td height=20 class=xl1524526 style='height:15.0pt'></td>
  <td class=xl1524526></td>
  <td class=xl1524526></td>
 </tr>
 <tr height=20 style='height:15.0pt'>
  <td height=20 class=xl1524526 colspan=2 style='height:15.0pt'>RUNNING THE
  SIMULATIONS</td>
  <td class=xl1524526></td>
 </tr>
 <tr height=20 style='height:15.0pt'>
  <td height=20 class=xl6524526 style='height:15.0pt'>Order</td>
  <td class=xl6524526 style='border-left:none'>File name</td>
  <td class=xl6524526 style='border-left:none'>Objective</td>
 </tr>
 <tr height=20 style='height:15.0pt'>
  <td height=20 class=xl6624526 align=right width=64 style='height:15.0pt;
  border-top:none;width:48pt'>11</td>
  <td class=xl6624526 width=394 style='border-top:none;border-left:none;
  width:296pt'>walltime_updater.R</td>
  <td class=xl6624526 width=589 style='border-top:none;border-left:none;
  width:442pt'>Creates a table with the id_10 and the expected walltime</td>
 </tr>
 <tr height=20 style='height:15.0pt'>
  <td height=20 class=xl6624526 align=right width=64 style='height:15.0pt;
  border-top:none;width:48pt'>12</td>
  <td class=xl6624526 width=394 style='border-top:none;border-left:none;
  width:296pt'>A_walltime_sender.sh</td>
  <td class=xl6624526 width=589 style='border-top:none;border-left:none;
  width:442pt'>For cluster: calls B_bash for each cell</td>
 </tr>
 <tr height=20 style='height:15.0pt'>
  <td height=20 class=xl6624526 align=right width=64 style='height:15.0pt;
  border-top:none;width:48pt'>13</td>
  <td class=xl6624526 width=394 style='border-top:none;border-left:none;
  width:296pt'>B_bash.sh</td>
  <td class=xl6624526 width=589 style='border-top:none;border-left:none;
  width:442pt'>For cluster: calls R using sigularity container</td>
 </tr>
 <tr height=20 style='height:15.0pt'>
  <td height=20 class=xl6624526 align=right width=64 style='height:15.0pt;
  border-top:none;width:48pt'>14</td>
  <td class=xl6624526 width=394 style='border-top:none;border-left:none;
  width:296pt'>APSIM_package.R</td>
  <td class=xl6624526 width=589 style='border-top:none;border-left:none;
  width:442pt'>Loads APSIM package (is deprecated for some R versions)</td>
 </tr>
 <tr height=20 style='height:15.0pt'>
  <td height=20 class=xl6624526 align=right width=64 style='height:15.0pt;
  border-top:none;width:48pt'>15</td>
  <td class=xl6624526 width=394 style='border-top:none;border-left:none;
  width:296pt'>simA_manager.R</td>
  <td class=xl6624526 width=589 style='border-top:none;border-left:none;
  width:442pt'>Controls the simulations. Calls the other scripts</td>
 </tr>
 <tr height=20 style='height:15.0pt'>
  <td height=20 class=xl6624526 align=right width=64 style='height:15.0pt;
  border-top:none;width:48pt'>16</td>
  <td class=xl6624526 width=394 style='border-top:none;border-left:none;
  width:296pt'>simB_create_instructions.R</td>
  <td class=xl6624526 width=589 style='border-top:none;border-left:none;
  width:442pt'>Creates the weather and soil files and the instructions for all
  simulations inside a cell</td>
 </tr>
 <tr height=20 style='height:15.0pt'>
  <td height=20 class=xl6624526 align=right width=64 style='height:15.0pt;
  border-top:none;width:48pt'>17</td>
  <td class=xl6624526 width=394 style='border-top:none;border-left:none;
  width:296pt'>simC_make_z_and_met_files.R</td>
  <td class=xl6624526 width=589 style='border-top:none;border-left:none;
  width:442pt'>Makes the met files</td>
 </tr>
 <tr height=20 style='height:15.0pt'>
  <td height=20 class=xl6624526 align=right width=64 style='height:15.0pt;
  border-top:none;width:48pt'>18</td>
  <td class=xl6624526 width=394 style='border-top:none;border-left:none;
  width:296pt'>simD_create_apsim_files.R</td>
  <td class=xl6624526 width=589 style='border-top:none;border-left:none;
  width:442pt'>Makes the apsim files</td>
 </tr>
 <tr height=20 style='height:15.0pt'>
  <td height=20 class=xl6624526 align=right width=64 style='height:15.0pt;
  border-top:none;width:48pt'>19</td>
  <td class=xl6624526 width=394 style='border-top:none;border-left:none;
  width:296pt'>simE_update_ic.R</td>
  <td class=xl6624526 width=589 style='border-top:none;border-left:none;
  width:442pt'>Updates the Initial conditions</td>
 </tr>
 <tr height=20 style='height:15.0pt'>
  <td height=20 class=xl6624526 align=right width=64 style='height:15.0pt;
  border-top:none;width:48pt'>20</td>
  <td class=xl6624526 width=394 style='border-top:none;border-left:none;
  width:296pt'>simF_run_files.R</td>
  <td class=xl6624526 width=589 style='border-top:none;border-left:none;
  width:442pt'>Run all the APSIM files</td>
 </tr>
 <tr height=20 style='height:15.0pt'>
  <td height=20 class=xl6624526 align=right width=64 style='height:15.0pt;
  border-top:none;width:48pt'>21</td>
  <td class=xl6624526 width=394 style='border-top:none;border-left:none;
  width:296pt'>simG_merge_results.R</td>
  <td class=xl6624526 width=589 style='border-top:none;border-left:none;
  width:442pt'>Merges APSIM output</td>
 </tr>
 <tr height=20 style='height:15.0pt'>
  <td height=20 class=xl6624526 align=right width=64 style='height:15.0pt;
  border-top:none;width:48pt'>22</td>
  <td class=xl6624526 width=394 style='border-top:none;border-left:none;
  width:296pt'>simH_daily_to_yearly.R</td>
  <td class=xl6624526 width=589 style='border-top:none;border-left:none;
  width:442pt'>Transforms APSIM output from daily data to yearly</td>
 </tr>
 <tr height=20 style='height:15.0pt'>
  <td height=20 class=xl1524526 style='height:15.0pt'></td>
  <td class=xl1524526></td>
  <td class=xl1524526></td>
 </tr>
 <tr height=20 style='height:15.0pt'>
  <td height=20 class=xl1524526 colspan=2 style='height:15.0pt'>PROCESSING AND
  ANALYZING THE RESULTS</td>
  <td class=xl1524526></td>
 </tr>
 <tr height=20 style='height:15.0pt'>
  <td height=20 class=xl6524526 style='height:15.0pt'>Order</td>
  <td class=xl6524526 style='border-left:none'>File name</td>
  <td class=xl6524526 style='border-left:none'>Objective</td>
 </tr>
 <tr height=20 style='height:15.0pt'>
  <td height=20 class=xl6724526 align=right style='height:15.0pt;border-top:
  none'>23</td>
  <td class=xl6724526 style='border-top:none;border-left:none'>parameters.R</td>
  <td class=xl6724526 style='border-top:none;border-left:none'>Setting
  parameters used during the work, like prices and fees</td>
 </tr>
 <tr height=20 style='height:15.0pt'>
  <td height=20 class=xl6724526 align=right style='height:15.0pt;border-top:
  none'>24</td>
  <td class=xl6724526 style='border-top:none;border-left:none'>2_post_processing_nov29.R</td>
  <td class=xl6724526 style='border-top:none;border-left:none'>Clean restuls.
  Remove outliers</td>
 </tr>
 <tr height=20 style='height:15.0pt'>
  <td height=20 class=xl6724526 align=right style='height:15.0pt;border-top:
  none'>25</td>
  <td class=xl6724526 style='border-top:none;border-left:none'>3a_regional_stations.R</td>
  <td class=xl6724526 style='border-top:none;border-left:none'>Selects the
  regional stations, used for training</td>
 </tr>
 <tr height=20 style='height:15.0pt'>
  <td height=20 class=xl6724526 align=right style='height:15.0pt;border-top:
  none'>26</td>
  <td class=xl6724526 style='border-top:none;border-left:none'>3b_fields_splitter.R</td>
  <td class=xl6724526 style='border-top:none;border-left:none'>Splits APSIM
  output by field, and aggregates it considering the area of each soil</td>
 </tr>
 <tr height=20 style='height:15.0pt'>
  <td height=20 class=xl6724526 align=right style='height:15.0pt;border-top:
  none'>27</td>
  <td class=xl6724526 style='border-top:none;border-left:none'>3d_train_and_evaluate_loyo_mar10.R</td>
  <td class=xl6724526 style='border-top:none;border-left:none'>Trains and
  evaluates models to provide N recommendation<span style='mso-spacerun:yes'>Â 
  </span>tools</td>
 </tr>
 <![if supportMisalignedColumns]>
 <tr height=0 style='display:none'>
  <td width=64 style='width:48pt'></td>
  <td width=394 style='width:296pt'></td>
  <td width=589 style='width:442pt'></td>
 </tr>
 <![endif]>
</table>

</div>


<!----------------------------->
<!--END OF OUTPUT FROM EXCEL PUBLISH AS WEB PAGE WIZARD-->
<!----------------------------->
</body>

</html>
